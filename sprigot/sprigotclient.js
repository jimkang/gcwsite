function serializeTreedNode(a){var b=_.pick(a,"id","doc","title","body"),c=a.children;return a.children||(c=a._children),c&&(b.children=_.pluck(c,"id")),b}function sanitizeTreeForD3(a){if("object"==typeof a.children){for(var b=[],c=[],d=0;d<a.children.length;++d){var e=a.children[d];"object"==typeof e?c.push(e):b.push(e)}b.length>0&&(a.childRefs=b),c.length>0&&(a.children=c,a.children.forEach(sanitizeTreeForD3))}return a}function mapPathToSprigInD3Tree(a,b,c){if(a===b.id)return[b.id];for(var d=[],e={},f=null,g=0,h=null,i=[b];c>=g;){h=[];for(var j=0;j<i.length;++j){var k=i[j];if(k.id===a){f=k;break}if(c>=g+1&&k){var l=[];"object"==typeof k.children&&k.children?l=k.children:"object"==typeof k._children&&k._children&&(l=k._children),l.forEach(function(a){e[a.id]=k}),h=h.concat(l)}}if(f)break;g++,i=h}if(f)for(var k=f;k;)d.unshift(k),k=k.id in e?e[k.id]:null;return d}function uid(a){for(var b=[],c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=c.length,e=0;a>e;++e)b.push(c[getRandomInt(0,d-1)]);return b.join("")}function getRandomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}function request(a,b,c){var d=new XMLHttpRequest;d.open("POST",settings.serverURL),d.setRequestHeader("Content-Type","application/json"),d.setRequestHeader("accept","application/json"),d.onload=function(){if(200===this.status){var a=JSON.parse(this.responseText);c(null,a)}else c(this.status,null)},d.send(JSON.stringify(b))}function OKCancelDialog(a,b,c,d,e){this.parentSelector=a,this.text=b,this.okText=c,this.respondToOK=d,this.cleanUpFunction=e}function createTreeNav(){var a={sprigTree:null,graphCamera:null,treeRenderer:null,graph:null,textStuff:null};return a.init=function(a,b,c,d,e){this.sprigTree=a,this.graphCamera=b,this.treeRenderer=c,this.graph=d,this.textStuff=e},a.chooseTreeNode=function(a,b){this.toggleChildren(a),this.graph.focusOnTreeNode(a,b),TextStuff.showTextpaneForTreeNode(a)},a.toggleChildren=function(a){a.children?(a._children=a.children,a.children=null):this.expandChildren(a)},a.expandChildren=function(a){a._children&&(a.children=a._children,a._children=null)},a.collapseRecursively=function(b){b.children&&(b._children=b.children,b._children.forEach(a.collapseRecursively),b.children=null)},a.nodeIsExpanded=function(a){return a.children&&!a._children},a.followBranchOfNode=function(a){var b=0;if("object"==typeof a.children&&b<a.children.length){var c=a.children[b],d=d3.select("#"+c.id).node();this.chooseTreeNode(c,d)}},a.followParentOfNode=function(a){if("object"==typeof a.parent){var b=d3.select("#"+a.parent.id);this.chooseTreeNode(a.parent,b.node()),this.graphCamera.panToElement(b)}},a.moveToSiblingNode=function(a,b){if("object"==typeof a.parent&&"object"==typeof a.parent.children){var c=a.parent.children.indexOf(a),d=c+b;if(d>-1&&d<a.parent.children.length){var e=a.parent.children[d],f=d3.select("#"+e.id).node();e._children&&this.expandChildren(e),this.graph.focusOnTreeNode(e,f),this.textStuff.showTextpaneForTreeNode(e)}}},a.goToSprig=function(a,b){var c=mapPathToSprigInD3Tree(a,this.sprigTree,100);c.length>1&&(c.forEach(function(a){this.expandChildren(a)}.bind(this)),this.treeRenderer.update(this.sprigTree,0,function(){this.graph.focusOnSprig(a,b)}.bind(this)))},a.respondToDownArrow=function(){d3.event.stopPropagation(),this.nodeIsExpanded(this.graph.focusNode)?this.followBranchOfNode(this.graph.focusNode):this.chooseTreeNode(this.graph.focusNode,d3.select("#"+this.graph.focusNode.id).node())},a.respondToUpArrow=function(){d3.event.stopPropagation(),this.nodeIsExpanded(this.graph.focusNode)?(this.collapseRecursively(this.graph.focusNode),this.treeRenderer.update(this.graph.focusNode)):this.followParentOfNode(this.graph.focusNode)},a.respondToLeftArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,-1)},a.respondToRightArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,1)},a}function createGraph(){var a={camera:null,treeRenderer:null,treeNav:null,textStuff:null,historian:null,pane:null,board:null,svgRoot:null,focusEl:null,focusNode:null,nodeRoot:null};return a.init=function(a,b,c,d,e){return this.camera=b,this.treeRenderer=c,this.treeNav=createTreeNav(),this.textStuff=d,this.historian=e,this.pane=a.append("div").attr("id","graphPane").classed("pane",!0),this.board=this.pane.append("svg").attr({id:"svgBoard",width:"100%",height:"100%"}),this.board.append("g").attr("id","background").append("rect").attr({width:"100%",height:"100%",fill:"rgba(0, 0, 16, 0.2)"}),this.svgRoot=this.board.append("g").attr({id:"graphRoot",transform:"translate("+margin.left+","+margin.top+")"}),this.camera.setUpZoomOnBoard(this.board,this.svgRoot),this.setGraphScale(),this},a.loadNodeTreeToGraph=function(a,b){this.nodeRoot=a,this.treeRenderer.init(this.nodeRoot,this),this.treeNav.init(this.nodeRoot,Camera,TreeRenderer,this,this.textStuff);var c=this.board.node().clientHeight-margin.top-margin.bottom;this.nodeRoot.x0=c/2,this.nodeRoot.y0=0,this.treeNav.collapseRecursively(this.nodeRoot),b?this.treeNav.goToSprig(b):(b=this.nodeRoot.id,this.treeRenderer.update(this.nodeRoot)),setTimeout(function(){var a=d3.select("#"+b);this.setFocusEl(a.node()),this.camera.panToElement(a),this.textStuff.initialTextPaneShow(a)}.bind(this),800)},a.setGraphScale=function(){var a=this.camera.getActualHeight(this.board.node());230>=a&&(this.camera.rootSelection.attr("transform","translate(0, 0) scale(0.5)"),this.camera.zoomBehavior.scale(.5))},a.setFocusEl=function(a){this.focusEl=a,this.focusNode=d3.select(this.focusEl).datum()},a.focusOnTreeNode=function(a,b){this.setFocusEl(b),a.visited=!0,this.historian.syncURLToSprigId(a.id),TreeRenderer.update(this.nodeRoot),Camera.panToElement(d3.select(this.focusEl))},a.focusOnSprig=function(a,b){b||(b=500);var c=d3.select("#"+a);setTimeout(function(){this.focusOnTreeNode(c.datum(),c.node())}.bind(this),b)},a.nodeHasFocus=function(a){return a===this.focusNode},a}function direct(a){var b=a.split("/");if(!(b.length<2))switch(b[1]){case"index":break;default:var c=b[1];if(b.length>1)var d=b[2];Sprigot.init(c,d)}}var Camera={locked:!1,rootSelection:null,boardSelection:null,zoomBehavior:null,parsedPreLockTransform:null,setUpZoomOnBoard:function(a,b){var c=this.getActualWidth(a.node()),d=this.getActualHeight(a.node()),e=d3.scale.linear().domain([0,c]).range([0,c]),f=d3.scale.linear().domain([0,d]).range([d,0]);Camera.zoomBehavior=d3.behavior.zoom().x(e).y(f).scaleExtent([1,1]).on("zoom",Camera.syncZoomEventToTransform),Camera.boardSelection=a,Camera.boardSelection.call(Camera.zoomBehavior),Camera.rootSelection=b},syncZoomEventToTransform:function(){Camera.locked||Camera.rootSelection.attr("transform","translate("+d3.event.translate+")"+" scale("+d3.event.scale+")")},resetZoom:function(){Camera.locked||rootSelection.attr("transform","translate(0, 0) scale(1)")},lockZoomToDefault:function(){Camera.resetZoom(),Camera.locked=!0},lockZoom:function(){Camera.locked=!0},unlockZoom:function(){Camera.locked=!1,Camera.parsedPreLockTransform&&(Camera.tweenToNewZoom(Camera.parsedPreLockTransform.scale,Camera.parsedPreLockTransform.translate,300),Camera.parsedPreLockTransform=null)},lockZoomToDefaultCenterPanAtDataCoords:function(a){Camera.parsedPreLockTransform=Camera.parseScaleAndTranslateFromTransformString(Camera.rootSelection.attr("transform")),Camera.panToCenterOnRect(a),Camera.lockZoom()},panToCenterOnRect:function(a,b){b||(b=300);var c=this.getActualWidth(this.boardSelection.node()),d=this.getActualHeight(this.boardSelection.node()),e=1,f=Camera.rootSelection.attr("transform");if(f){var g=Camera.parseScaleAndTranslateFromTransformString(f);e=g.scale}Camera.tweenToNewZoom(e,[-a.x-a.width/2+c/2,-a.y-a.height/2+d/2],b)},tweenToNewZoom:function(a,b,c){var d=Camera.rootSelection.attr("transform");d3.transition().duration(c).tween("zoom",function(){var c=1,e=[0,0];if(d){var f=Camera.parseScaleAndTranslateFromTransformString(d);c=f.scale,e=f.translate}var g=d3.interpolate(c,a);return interpolateTranslation=d3.interpolate(e,b),function(a){var b=g(a);Camera.zoomBehavior.scale(b);var c=interpolateTranslation(a);Camera.zoomBehavior.translate(c),Camera.rootSelection.attr("transform","translate("+c[0]+", "+c[1]+")"+" scale("+b+")")}})},parseScaleAndTranslateFromTransformString:function(a){var b={scale:1,translate:[0,0]};if(a&&a.length>0){var c=a.split("scale(")[1];c&&(b.scale=parseFloat(c.substr(0,c.length-1)));var d=a.split(") ")[0].split(",");b.translate=[parseFloat(d[0].substr(10)),parseFloat(d[1])],b.translate[1]||console.log("Got NaN out of",d)}return b},getActualHeight:function(a){var b=a.clientHeight;return 1>b&&(b=a.parentNode.clientHeight),b},getActualWidth:function(a){var b=a.clientWidth;return 1>b&&(b=a.parentNode.clientWidth),b},translateYFromSel:function(a){return a.attr("transform").split(",")[1].split(".")[0]},translateXFromSel:function(a){return a.attr("transform").split(",")[0].split(".")[0].split("(")[1]},panToElement:function(a){var b=Camera.zoomBehavior.scale(),c=parseInt(Camera.translateYFromSel(a))*b,d=parseInt(Camera.translateXFromSel(a))*b;Camera.panToCenterOnRect({x:d,y:c,width:1,height:1},750)}};if("object"==typeof module)var _=require("underscore");else module={exports:{}};module.exports={serializeTreedNode:serializeTreedNode,sanitizeTreeForD3:sanitizeTreeForD3},module.exports.uid=uid,OKCancelDialog.prototype.show=function(){var a=d3.select(this.parentSelector).append("div").attr("id","OKCancelDialog").classed("notification",!0);a.append("p").attr("id","dialogText").text(this.text),a.append("button").attr("id","OKButton").text(this.okText?this.okText:"OK").on("click",this.respondToOKClick.bind(this)),a.append("button").attr("id","CancelButton").text("Cancel").on("click",this.respondToCancelClick.bind(this))},OKCancelDialog.prototype.respondToOKClick=function(){this.respondToOK(),this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()},OKCancelDialog.prototype.respondToCancelClick=function(){this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()};var Store={};Store.saveSprigFromTreeNode=function(a,b){var c=null;if(a&&(c=serializeTreedNode(a)),c){var d=TextStuff.makeId(4),e={};c.doc=b,e[d]={op:"saveSprig",params:c},request(settings.serverURL,e,function(a,b){return a?(console.log("Error while saving sprig:",a),void 0):(d in b&&"saved"===b[d].status?console.log("Sprig saved:",b):console.log("Sprig not saved."),void 0)})}},Store.saveChildAndParentSprig=function(a,b){var c={};c.saveChildSprigOp={op:"saveSprig",params:a},c.saveParentSprigOp={op:"saveSprig",params:b},request(settings.serverURL,c,function(a,b){return a?(console.log("Error while saving sprigs:",a),void 0):(console.log("Child sprig save status:",b.saveChildSprigOp.status),console.log("Parent sprig save status:",b.saveParentSprigOp.status),void 0)})},Store.deleteChildAndSaveParentSprig=function(a,b){var c={};c.deleteChildSprigOp={op:"deleteSprig",params:a},c.saveParentSprigOp={op:"saveSprig",params:b},request(settings.serverURL,c,function(a,b){return a?(console.log("Error while saving sprigs:",a),void 0):(console.log("Sprig deletion status:",b.deleteChildSprigOp.status),console.log("Parent sprig save status:",b.saveParentSprigOp.status),void 0)})},Store.getSprigTree=function(a,b){var c={op:"getDoc",params:{id:a,childDepth:40}};request(settings.serverURL,{getDocReq:c},function(a,c){return a?(b&&b(a,null),void 0):("getDocReq"in c&&"got"===c.getDocReq.status?b&&b(null,c.getDocReq.result.sprigTree):b&&b(null,null),void 0)})},Store.createNewDoc=function(){request(settings.serverURL,{docPostReq1:{op:"saveDoc",params:{id:uid(4),rootSprig:"notonline",authors:["ignignokt"],admins:["ignignokt"]}}},function(a,b){a?console.log("Error while saving doc:",a):console.log("Saved doc:",b)})};var TreeRenderer={treeLayout:null,diagonalProjection:null,sprigTree:null,graphSVGGroup:null,graph:null};TreeRenderer.init=function(a,b){this.treeLayout=d3.layout.tree(),this.treeLayout.nodeSize([160,160]),this.sprigTree=a,this.diagonalProjection=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),this.graph=b,this.graphSVGGroup=b.svgRoot},TreeRenderer.update=function(a,b,c){b||(b=settings.treeNodeAnimationDuration);var d=this.treeLayout.nodes(this.sprigTree).reverse();d.forEach(function(a){var b=a.x,c=a.x0;a.x=a.y,a.x0=a.y0,a.y=b,a.y0=c});var e=this.treeLayout.links(d);d.forEach(function(a){a.x=180*a.depth});var f=this.graphSVGGroup.selectAll("g.node").data(d,function(a){return a.id||(a.id=++i)}),g=f.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+a.y0+","+a.x0+")"}).attr("id",function(a){return a.id}).on("click",TreeRenderer.respondToNodeClick);g.append("circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}).style("fill-opacity",.7).style("stroke","rgba(0, 64, 192, 0.7)"),g.append("text").attr("x",function(a){return a.children||a._children?"0.3em":"-0.3em"}).attr("y","-1em").attr("dy",".35em").attr("text-anchor",function(a){return a.y>0?"start":"end"}).text(function(a){return a.title}).style("fill-opacity",1e-6);var h=f.transition().duration(b).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});h.select("circle").attr("r",8).style("fill",function(a){var b="#08a";return this.graph.nodeHasFocus(a)?b="#e0362f":a.visited&&(b="lightsteelblue"),b}.bind(this)).style("fill-opacity",function(a){var b=.7;return this.graph.nodeHasFocus(a)&&(b=1),b}.bind(this)).style("stroke-width",function(a){return a._children&&a._children.length>0?"1.4em":0}),h.select("text").style("fill-opacity",1);var j=f.exit().transition().duration(b).attr("transform",function(){return"translate("+a.y+","+a.x+")"}).remove();j.select("circle").attr("r",1e-6),j.select("text").style("fill-opacity",1e-6);var k=this.graphSVGGroup.selectAll("path.link").data(e,function(a){return a.target.id});k.enter().insert("path","g").attr("class","link").attr("d",function(){var b={x:a.x0,y:a.y0};return this.diagonalProjection({source:b,target:b})}.bind(this)),k.attr("d",this.diagonalProjection).attr("stroke-width",function(a){return"boolean"==typeof a.target.emphasize&&a.target.emphasize?4:1.5}),k.exit().transition().duration(b).attr("d",function(){var b={x:a.x,y:a.y};return this.diagonalProjection({source:b,target:b})}.bind(this)).remove(),d.forEach(function(a){a.x0=a.x,a.y0=a.y}),c&&c()},TreeRenderer.respondToNodeClick=function(a){TreeRenderer.graph.treeNav.chooseTreeNode(a,this)};var TextStuff={graph:null,treeRenderer:null,store:null,sprigot:null,divider:null,pane:null,textpane:null,textcontent:null,titleField:null,editZone:null,addButton:null,deleteButton:null,emphasizeCheckbox:null,OKCancelDialog:null,editAvailable:!0};TextStuff.init=function(a,b,c,d,e,f){this.graph=b,this.treeRenderer=c,this.store=d,this.sprigot=e,this.divider=f,this.pane=a.append("div").classed("pane",!0).attr("id","nongraphPane"),this.pane.append("div").attr("id","questionDialog"),this.textpane=this.pane.append("div").attr("id","textpane"),this.editZone=this.textpane.append("div").classed("editZone",!0),this.titleField=this.editZone.append("span").classed("sprigTitleField",!0),this.textcontent=this.editZone.append("div").classed("textcontent",!0).attr("tabindex",0),this.editAvailable&&(this.addButton=this.textpane.append("button").text("+").classed("newsprigbutton",!0).classed("editcontrol",!0),this.deleteButton=this.textpane.append("button").text("-").classed("deletesprigbutton",!0).classed("editcontrol",!0),this.emphasizeCheckbox=this.textpane.append("label").text("Emphasize").classed("editcontrol",!0),this.textpane.append("input").attr({type:"checkbox",id:"emphasize"}).classed("editcontrol",!0)),this.editZone.style("display","none"),this.titleField.style("display","none"),d3.selectAll("#textpane *").style("display","none"),this.editAvailable&&(this.textcontent.on("click",this.startEditing.bind(this)),this.titleField.on("click",this.startEditing.bind(this)),this.addButton.on("click",this.sprigot.respondToAddChildSprigCmd),this.deleteButton.on("click",this.showDeleteSprigDialog),this.emphasizeCheckbox.on("click",this.respondToEmphasisCheckClick.bind(this)),this.editZone.on("keydown",this.respondToEditZoneKeyDown.bind(this)))},TextStuff.syncTextpaneWithTreeNode=function(a){this.textcontent.datum(a),this.titleField.datum(a),this.textcontent.html(a.body),this.titleField.html(a.title),this.emphasizeCheckbox.attr("value",this.graph.focusNode.emphasize?"on":null)},TextStuff.showTextpaneForTreeNode=function(a){this.syncTextpaneWithTreeNode(a),d3.selectAll("#textpane :not(.sprigTitleField)").style("display","block"),this.editZone.style("display","block"),this.uncollapseTextpane()},TextStuff.fadeInTextPane=function(a){if("none"===this.editZone.style("display")){var b=d3.selectAll("#textpane :not(.sprigTitleField)");this.textpane.style("opacity",0),b.style("opacity",0),this.editZone.style("opacity",0),b.style("display","block").transition().duration(a).style("opacity",1),this.editZone.style("display","block").transition().duration(a).style("opacity",1),this.textpane.transition().duration(a).style("opacity",1)}},TextStuff.initialTextPaneShow=function(a){setTimeout(function(){this.syncTextpaneWithTreeNode(a.datum(),this.graph.focusEl),this.fadeInTextPane(750)}.bind(this),725)},TextStuff.uncollapseTextpane=function(){var a=this.pane.classed("collapsedPane");a&&this.divider.toggleGraphExpansion()},TextStuff.showTitle=function(){this.titleField.text(this.titleField.datum().title),this.titleField.style("display","block")},TextStuff.makeId=function(a){return"s"+uid(a)},TextStuff.changeEditMode=function(a,b){if(this.editAvailable)if(this.textcontent.attr("contenteditable",a),this.titleField.attr("contenteditable",a),this.editZone.classed("editing",a),a)this.showTitle(),this.textcontent.node().focus();else{this.titleField.style("display","none");var c=this.textcontent.datum();c.body=this.textcontent.html();var d=this.titleField.text(),e=d!==c.title;c.title=d,e&&d3.select("#"+c.id+" text").text(c.title),this.textcontent.datum(c),this.titleField.datum(c),b||this.store.saveSprigFromTreeNode(this.textcontent.datum(),this.sprigot.docId)}},TextStuff.endEditing=function(){this.editZone.classed("editing")&&this.changeEditMode(!1)},TextStuff.showDeleteSprigDialog=function(){this.OKCancelDialog=new OKCancelDialog("#questionDialog","Do you want to delete this?","Delete",this.sprigot.respondToDeleteSprigCmd,function(){delete this.OKCancelDialog}.bind(this)),this.OKCancelDialog.show()},TextStuff.respondToEmphasisCheckClick=function(){this.graph.focusNode&&(this.graph.focusNode.emphasize="on"===this.value,this.treeRenderer.update(this.graph.nodeRoot))},TextStuff.respondToEditZoneKeyDown=function(){(d3.event.metaKey||d3.event.ctrlKey)&&13===d3.event.which&&(d3.event.stopPropagation(),this.editZone.classed("editing")&&this.changeEditMode(!1))},TextStuff.startEditing=function(){d3.event.stopPropagation(),this.editZone.classed("editing")||this.changeEditMode(!0)};var Divider={expanderArrow:null,graph:null,textStuff:null,camera:null};Divider.init=function(a,b,c,d){this.graph=b,this.textStuff=c,this.camera=d,this.expanderArrow=a.append("div").classed("divider",!0).append("svg").classed("arrowboard",!0).append("polygon").attr({id:"expanderArrow",fill:"rgba(0, 0, 64, 0.4)",stroke:"#E0EBFF","stroke-width":1,points:"0,0 32,24 0,48",transform:"translate(0, 0)"}),this.expanderArrow.on("click",this.toggleGraphExpansion.bind(this))},Divider.syncExpanderArrow=function(){var a=this.textStuff.pane.classed("collapsedPane"),b=a?36:6,c="translate("+b+", 0) ";c+="scale("+(a?"-1":"1")+", 1)",this.expanderArrow.transition().duration(500).ease("linear").attr("transform",c).attr("stroke-opacity",.5).attr("stroke-width",2).transition().delay(501).duration(500).attr("stroke-opacity",.15).attr("stroke-width",1)},Divider.toggleGraphExpansion=function(){var a=this.textStuff.pane.classed("collapsedPane"),b=!a;this.textStuff.pane.classed("collapsedPane",b).classed("pane",!b),this.graph.pane.classed("expandedPane",b).classed("pane",!b),this.syncExpanderArrow(),this.graph.focusEl&&this.camera.panToElement(d3.select(this.graph.focusEl))};var Historian={treeNav:null,docId:null};Historian.init=function(a,b){this.treeNav=a,this.docId=b,window.onpopstate=this.statePopped.bind(this)},Historian.statePopped=function(a){a.state&&(this.docId=a.state.docId,this.treeNav.goToSprig(a.state.sprigId,100))},Historian.syncURLToSprigId=function(a){if("object"!=typeof window.history.state||!window.history.state||"string"!=typeof window.history.state.docId||"string"!=typeof window.history.state.sprigId||window.history.state.docId!==this.docId||window.history.state.sprigId!==a){var b=location.protocol+"//"+location.host+"#/"+this.docId+"/"+a;window.history.pushState({docId:this.docId,sprigId:a},null,b)}};var margin={top:20,right:10,bottom:20,left:10},settings={serverURL:"http://sprigot-8939.onmodulus.net",treeNodeAnimationDuration:750},Sprigot={docId:null,graph:null};Sprigot.init=function(a,b){this.docId=a;var c=d3.select("body").append("section").attr("id","sprigot");this.graph=createGraph(),this.graph.init(c,Camera,TreeRenderer,TextStuff,Historian),Divider.init(c,this.graph,TextStuff,Camera),TextStuff.init(c,this.graph,TreeRenderer,Store,this,Divider),Historian.init(this.graph.treeNav,this.docId),Divider.syncExpanderArrow(),this.initDocEventResponders(),Store.getSprigTree(a,function(a,c){if(a)return console.log("Error while getting sprig:",a),void 0;if(c){var d=sanitizeTreeForD3(c);this.graph.loadNodeTreeToGraph(d,b),console.log("Loaded tree:",c)}else console.log("Sprig tree not found.")}.bind(this))},Sprigot.initDocEventResponders=function(){var a=d3.select(document);TextStuff.editAvailable&&a.on("click",TextStuff.endEditing.bind(TextStuff)),a.on("keyup",this.respondToDocKeyUp.bind(this)),a.on("keydown",this.respondToDocKeyDown.bind(this))},Sprigot.respondToDocKeyUp=function(){if(27===d3.event.keyCode)d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1);else if(!TextStuff.editZone.classed("editing"))switch(d3.event.which){case 69:d3.event.stopPropagation(),"block"===TextStuff.editZone.style("display")&&TextStuff.changeEditMode(!0);break;case 40:this.graph.treeNav.respondToDownArrow();break;case 38:this.graph.treeNav.respondToUpArrow();break;case 37:this.graph.treeNav.respondToLeftArrow();break;case 39:this.graph.treeNav.respondToRightArrow();break;case 187:d3.event.shiftKey&&respondToAddChildSprigCmd()}},Sprigot.respondToDocKeyDown=function(){(d3.event.metaKey||d3.event.ctrlKey)&&8===d3.event.which&&TextStuff.showDeleteSprigDialog()},Sprigot.respondToAddChildSprigCmd=function(){d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1);var a={id:TextStuff.makeId(8),doc:this.docId,title:"New Sprig",body:""},b=this.graph.focusNode.children;b||(b=this.graph.focusNode._children),b||(b=[]),b.push(a),this.graph.focusNode.children=b,TextStuff.changeEditMode(!0),Store.saveChildAndParentSprig(a,serializeTreedNode(this.graph.focusNode)),TreeRenderer.update(this.graph.nodeRoot,settings.treeNodeAnimationDuration,function(){this.graph.focusOnSprig(a.id),TextStuff.showTextpaneForTreeNode(a)})},Sprigot.respondToDeleteSprigCmd=function(){d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1,!0);var a=this.graph.focusNode.parent,b=a.children.indexOf(this.graph.focusNode);a.children.splice(b,1);var c={id:this.graph.focusNode.id,doc:this.docId};Store.deleteChildAndSaveParentSprig(c,serializeTreedNode(a)),TreeRenderer.update(this.graph.nodeRoot,settings.treeNodeAnimationDuration,function(){setTimeout(function(){this.graph.treeNav.chooseTreeNode(a,d3.select("#"+a.id).node())},500)})},direct(location.hash);