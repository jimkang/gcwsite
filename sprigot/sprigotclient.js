function serializeTreedNode(e){var t=_.pick(e,"id","doc","title","body"),i=e.children;return e.children||(i=e._children),i&&(t.children=_.pluck(i,"id")),t}function sanitizeTreeForD3(e){if("object"==typeof e.children){for(var t=[],i=[],n=0;n<e.children.length;++n){var o=e.children[n];"object"==typeof o?i.push(o):t.push(o)}t.length>0&&(e.childRefs=t),i.length>0&&(e.children=i,e.children.forEach(sanitizeTreeForD3))}return e}function mapPathToSprigInD3Tree(e,t,i){if(e===t.id)return[t.id];for(var n=[],o={},r=null,a=0,s=null,d=[t];i>=a;){s=[];for(var l=0;l<d.length;++l){var c=d[l];if(c.id===e){r=c;break}if(i>=a+1&&c){var h=[];"object"==typeof c.children&&c.children?h=c.children:"object"==typeof c._children&&c._children&&(h=c._children),h.forEach(function(e){o[e.id]=c}),s=s.concat(h)}}if(r)break;a++,d=s}if(r)for(var c=r;c;)n.unshift(c),c=c.id in o?o[c.id]:null;return n}function uid(e){for(var t=[],i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=i.length,o=0;e>o;++o)t.push(i[getRandomInt(0,n-1)]);return t.join("")}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function request(e,t,i){var n=new XMLHttpRequest;n.open("POST",settings.serverURL),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("accept","application/json"),n.onload=function(){if(200===this.status){var e=JSON.parse(this.responseText);i(null,e)}else i(this.status,null)},n.send(JSON.stringify(t))}function OKCancelDialog(e,t,i,n,o){this.parentSelector=e,this.text=t,this.okText=i,this.respondToOK=n,this.cleanUpFunction=o}function createTreeNav(){var e={sprigTree:null,graphCamera:null,treeRenderer:null,graph:null,textStuff:null};return e.init=function(e,t,i,n,o){this.sprigTree=e,this.graphCamera=t,this.treeRenderer=i,this.graph=n,this.textStuff=o},e.chooseTreeNode=function(e,t){this.toggleChildren(e),this.graph.focusOnTreeNode(e,t),TextStuff.showTextpaneForTreeNode(e)},e.toggleChildren=function(e){e.children?(e._children=e.children,e.children=null):this.expandChildren(e)},e.expandChildren=function(e){e._children&&(e.children=e._children,e._children=null)},e.collapseRecursively=function(t){t.children&&(t._children=t.children,t._children.forEach(e.collapseRecursively),t.children=null)},e.nodeIsExpanded=function(e){return e.children&&!e._children},e.followBranchOfNode=function(e){var t=0;if("object"==typeof e.children&&t<e.children.length){var i=e.children[t],n=d3.select("#"+i.id).node();this.chooseTreeNode(i,n)}},e.followParentOfNode=function(e){if("object"==typeof e.parent){var t=d3.select("#"+e.parent.id);this.chooseTreeNode(e.parent,t.node()),this.graphCamera.panToElement(t)}},e.moveToSiblingNode=function(e,t){if("object"==typeof e.parent&&"object"==typeof e.parent.children){d3.select("#"+e.parent.id);var i=e.parent.children.indexOf(e),n=i+t;if(n>-1&&n<e.parent.children.length){var o=e.parent.children[n],r=d3.select("#"+o.id).node();o._children&&this.expandChildren(o),this.graph.focusOnTreeNode(o,r),this.textStuff.showTextpaneForTreeNode(o)}}},e.goToSprig=function(e,t){var i=mapPathToSprigInD3Tree(e,this.sprigTree,100);i.length>1&&(i.forEach(function(e){this.expandChildren(e)}.bind(this)),this.treeRenderer.update(this.sprigTree,0,function(){this.graph.focusOnSprig(e,t)}.bind(this)))},e.respondToDownArrow=function(){d3.event.stopPropagation(),this.nodeIsExpanded(this.graph.focusNode)?this.followBranchOfNode(this.graph.focusNode):this.chooseTreeNode(this.graph.focusNode,d3.select("#"+this.graph.focusNode.id).node())},e.respondToUpArrow=function(){d3.event.stopPropagation(),this.nodeIsExpanded(this.graph.focusNode)?(this.collapseRecursively(this.graph.focusNode),this.treeRenderer.update(this.graph.focusNode)):this.followParentOfNode(this.graph.focusNode)},e.respondToLeftArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,-1)},e.respondToRightArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,1)},e}function createGraph(){var e={camera:null,treeRenderer:null,treeNav:null,textStuff:null,historian:null,pane:null,board:null,svgRoot:null,focusEl:null,focusNode:null,nodeRoot:null};return e.init=function(e,t,i,n,o){return this.camera=t,this.treeRenderer=i,this.treeNav=createTreeNav(),this.textStuff=n,this.historian=o,this.pane=e.append("div").attr("id","graphPane").classed("pane",!0),this.board=this.pane.append("svg").attr({id:"svgBoard",width:"100%",height:"100%"}),this.board.append("g").attr("id","background").append("rect").attr({width:"100%",height:"100%",fill:"rgba(0, 0, 16, 0.2)"}),this.svgRoot=this.board.append("g").attr({id:"graphRoot",transform:"translate("+margin.left+","+margin.top+")"}),this.camera.setUpZoomOnBoard(this.board,this.svgRoot),this.setGraphScale(),this},e.loadNodeTreeToGraph=function(e,t){this.nodeRoot=e,this.treeRenderer.init(this.nodeRoot,this),this.treeNav.init(this.nodeRoot,Camera,TreeRenderer,this,this.textStuff);var i=this.board.node().clientHeight-margin.top-margin.bottom;this.nodeRoot.x0=i/2,this.nodeRoot.y0=0,this.treeNav.collapseRecursively(this.nodeRoot),t?this.treeNav.goToSprig(t):(t=this.nodeRoot.id,this.treeRenderer.update(this.nodeRoot)),setTimeout(function(){var e=d3.select("#"+t);this.setFocusEl(e.node()),this.camera.panToElement(e),this.textStuff.initialTextPaneShow(e)}.bind(this),800)},e.setGraphScale=function(){var e=this.camera.getActualHeight(this.board.node());230>=e&&(this.camera.rootSelection.attr("transform","translate(0, 0) scale(0.5)"),this.camera.zoomBehavior.scale(.5))},e.setFocusEl=function(e){this.focusEl=e,this.focusNode=d3.select(this.focusEl).datum()},e.focusOnTreeNode=function(e,t){this.setFocusEl(t),e.visited=!0,this.historian.syncURLToSprigId(e.id),TreeRenderer.update(this.nodeRoot),Camera.panToElement(d3.select(this.focusEl))},e.focusOnSprig=function(e,t){t||(t=500);var i=d3.select("#"+e);setTimeout(function(){this.focusOnTreeNode(i.datum(),i.node())}.bind(this),t)},e.nodeHasFocus=function(e){return e===this.focusNode},e}function direct(e){var t=e.split("/");if(!(t.length<2))switch(t[1]){case"index":break;default:var i=t[1];if(t.length>1)var n=t[2];Sprigot.init(i,n)}}var Camera={locked:!1,rootSelection:null,boardSelection:null,zoomBehavior:null,parsedPreLockTransform:null,setUpZoomOnBoard:function(e,t){var i=this.getActualWidth(e.node()),n=this.getActualHeight(e.node()),o=d3.scale.linear().domain([0,i]).range([0,i]),r=d3.scale.linear().domain([0,n]).range([n,0]);Camera.zoomBehavior=d3.behavior.zoom().x(o).y(r).scaleExtent([1,1]).on("zoom",Camera.syncZoomEventToTransform),Camera.boardSelection=e,Camera.boardSelection.call(Camera.zoomBehavior),Camera.rootSelection=t},syncZoomEventToTransform:function(){Camera.locked||Camera.rootSelection.attr("transform","translate("+d3.event.translate+")"+" scale("+d3.event.scale+")")},resetZoom:function(){Camera.locked||rootSelection.attr("transform","translate(0, 0) scale(1)")},lockZoomToDefault:function(){Camera.resetZoom(),Camera.locked=!0},lockZoom:function(){Camera.locked=!0},unlockZoom:function(){Camera.locked=!1,Camera.parsedPreLockTransform&&(Camera.tweenToNewZoom(Camera.parsedPreLockTransform.scale,Camera.parsedPreLockTransform.translate,300),Camera.parsedPreLockTransform=null)},lockZoomToDefaultCenterPanAtDataCoords:function(e){Camera.parsedPreLockTransform=Camera.parseScaleAndTranslateFromTransformString(Camera.rootSelection.attr("transform")),Camera.panToCenterOnRect(e),Camera.lockZoom()},panToCenterOnRect:function(e,t){t||(t=300);var i=this.getActualWidth(this.boardSelection.node()),n=this.getActualHeight(this.boardSelection.node()),o=1,r=Camera.rootSelection.attr("transform");if(r){var a=Camera.parseScaleAndTranslateFromTransformString(r);o=a.scale}Camera.tweenToNewZoom(o,[-e.x-e.width/2+i/2,-e.y-e.height/2+n/2],t)},tweenToNewZoom:function(e,t,i){var n=Camera.rootSelection.attr("transform");d3.transition().duration(i).tween("zoom",function(){var i=1,o=[0,0];if(n){var r=Camera.parseScaleAndTranslateFromTransformString(n);i=r.scale,o=r.translate}var a=d3.interpolate(i,e);return interpolateTranslation=d3.interpolate(o,t),function(e){var t=a(e);Camera.zoomBehavior.scale(t);var i=interpolateTranslation(e);Camera.zoomBehavior.translate(i),Camera.rootSelection.attr("transform","translate("+i[0]+", "+i[1]+")"+" scale("+t+")")}})},parseScaleAndTranslateFromTransformString:function(e){var t={scale:1,translate:[0,0]};if(e&&e.length>0){var i=e.split("scale(")[1];i&&(t.scale=parseFloat(i.substr(0,i.length-1)));var n=e.split(") ")[0].split(",");t.translate=[parseFloat(n[0].substr(10)),parseFloat(n[1])],t.translate[1]||console.log("Got NaN out of",n)}return t},getActualHeight:function(e){var t=e.clientHeight;return 1>t&&(t=e.parentNode.clientHeight),t},getActualWidth:function(e){var t=e.clientWidth;return 1>t&&(t=e.parentNode.clientWidth),t},translateYFromSel:function(e){return e.attr("transform").split(",")[1].split(".")[0]},translateXFromSel:function(e){return e.attr("transform").split(",")[0].split(".")[0].split("(")[1]},panToElement:function(e){var t=Camera.zoomBehavior.scale(),i=parseInt(Camera.translateYFromSel(e))*t,n=parseInt(Camera.translateXFromSel(e))*t;Camera.panToCenterOnRect({x:n,y:i,width:1,height:1},750)}};if("object"==typeof module)var _=require("underscore");else module={exports:{}};module.exports={serializeTreedNode:serializeTreedNode,sanitizeTreeForD3:sanitizeTreeForD3},module.exports.uid=uid,OKCancelDialog.prototype.show=function(){var e=d3.select(this.parentSelector).append("div").attr("id","OKCancelDialog").classed("notification",!0);e.append("p").attr("id","dialogText").text(this.text),e.append("button").attr("id","OKButton").text(this.okText?this.okText:"OK").on("click",this.respondToOKClick.bind(this)),e.append("button").attr("id","CancelButton").text("Cancel").on("click",this.respondToCancelClick.bind(this))},OKCancelDialog.prototype.respondToOKClick=function(){this.respondToOK(),this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()},OKCancelDialog.prototype.respondToCancelClick=function(){this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()};var Store={};Store.saveSprigFromTreeNode=function(e,t){var i=null;if(e&&(i=serializeTreedNode(e)),i){var n=TextStuff.makeId(4),o={};i.doc=t,o[n]={op:"saveSprig",params:i},request(settings.serverURL,o,function(e,t){return e?(console.log("Error while saving sprig:",e),void 0):(n in t&&"saved"===t[n].status?console.log("Sprig saved:",t):console.log("Sprig not saved."),void 0)})}},Store.saveChildAndParentSprig=function(e,t){var i={};i.saveChildSprigOp={op:"saveSprig",params:e},i.saveParentSprigOp={op:"saveSprig",params:t},request(settings.serverURL,i,function(e,t){return e?(console.log("Error while saving sprigs:",e),void 0):(console.log("Child sprig save status:",t.saveChildSprigOp.status),console.log("Parent sprig save status:",t.saveParentSprigOp.status),void 0)})},Store.deleteChildAndSaveParentSprig=function(e,t){var i={};i.deleteChildSprigOp={op:"deleteSprig",params:e},i.saveParentSprigOp={op:"saveSprig",params:t},request(settings.serverURL,i,function(e,t){return e?(console.log("Error while saving sprigs:",e),void 0):(console.log("Sprig deletion status:",t.deleteChildSprigOp.status),console.log("Parent sprig save status:",t.saveParentSprigOp.status),void 0)})},Store.getSprigTree=function(e,t){var i={op:"getDoc",params:{id:e,childDepth:40}};request(settings.serverURL,{getDocReq:i},function(e,i){return e?(t&&t(e,null),void 0):("getDocReq"in i&&"got"===i.getDocReq.status?t&&t(null,i.getDocReq.result.sprigTree):t&&t(null,null),void 0)})},Store.createNewDoc=function(){request(settings.serverURL,{docPostReq1:{op:"saveDoc",params:{id:uid(4),rootSprig:"notonline",authors:["ignignokt"],admins:["ignignokt"]}}},function(e,t){e?console.log("Error while saving doc:",e):console.log("Saved doc:",t)})};var TreeRenderer={treeLayout:null,diagonalProjection:null,sprigTree:null,graphSVGGroup:null,graph:null};TreeRenderer.init=function(e,t){this.treeLayout=d3.layout.tree(),this.treeLayout.nodeSize([160,160]),this.sprigTree=e,this.diagonalProjection=d3.svg.diagonal().projection(function(e){return[e.y,e.x]}),this.graph=t,this.graphSVGGroup=t.svgRoot},TreeRenderer.update=function(e,t,n){t||(t=settings.treeNodeAnimationDuration);var o=this.treeLayout.nodes(this.sprigTree).reverse();o.forEach(function(e){var t=e.x,i=e.x0;e.x=e.y,e.x0=e.y0,e.y=t,e.y0=i});var r=this.treeLayout.links(o);o.forEach(function(e){e.x=180*e.depth});var a=this.graphSVGGroup.selectAll("g.node").data(o,function(e){return e.id||(e.id=++i)}),s=a.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+e.y0+","+e.x0+")"}).attr("id",function(e){return e.id}).on("click",TreeRenderer.respondToNodeClick);s.append("circle").attr("r",1e-6).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}).style("fill-opacity",.7).style("stroke","rgba(0, 64, 192, 0.7)"),s.append("text").attr("x",function(e){return e.children||e._children?"0.3em":"-0.3em"}).attr("y","-1em").attr("dy",".35em").attr("text-anchor",function(e){return e.y>0?"start":"end"}).text(function(e){return e.title}).style("fill-opacity",1e-6);var d=a.transition().duration(t).attr("transform",function(e){return"translate("+e.y+","+e.x+")"});d.select("circle").attr("r",8).style("fill",function(e){var t="#08a";return this.graph.nodeHasFocus(e)?t="#e0362f":e.visited&&(t="lightsteelblue"),t}.bind(this)).style("fill-opacity",function(e){var t=.7;return this.graph.nodeHasFocus(e)&&(t=1),t}.bind(this)).style("stroke-width",function(e){return e._children&&e._children.length>0?"1.4em":0}),d.select("text").style("fill-opacity",1);var l=a.exit().transition().duration(t).attr("transform",function(){return"translate("+e.y+","+e.x+")"}).remove();l.select("circle").attr("r",1e-6),l.select("text").style("fill-opacity",1e-6);var c=this.graphSVGGroup.selectAll("path.link").data(r,function(e){return e.target.id});c.enter().insert("path","g").attr("class","link").attr("d",function(){var t={x:e.x0,y:e.y0};return this.diagonalProjection({source:t,target:t})}.bind(this)),c.attr("d",this.diagonalProjection).attr("stroke-width",function(e){return"boolean"==typeof e.target.emphasize&&e.target.emphasize?4:1.5}),c.exit().transition().duration(t).attr("d",function(){var t={x:e.x,y:e.y};return this.diagonalProjection({source:t,target:t})}.bind(this)).remove(),o.forEach(function(e){e.x0=e.x,e.y0=e.y}),n&&n()},TreeRenderer.respondToNodeClick=function(e){TreeRenderer.graph.treeNav.chooseTreeNode(e,this)};var TextStuff={graph:null,treeRenderer:null,store:null,sprigot:null,divider:null,pane:null,textpane:null,textcontent:null,titleField:null,editZone:null,addButton:null,deleteButton:null,emphasizeCheckbox:null,OKCancelDialog:null,editAvailable:!0};TextStuff.init=function(e,t,i,n,o,r){this.graph=t,this.treeRenderer=i,this.store=n,this.sprigot=o,this.divider=r,this.pane=e.append("div").classed("pane",!0).attr("id","nongraphPane"),this.pane.append("div").attr("id","questionDialog"),this.textpane=this.pane.append("div").attr("id","textpane"),this.editZone=this.textpane.append("div").classed("editZone",!0),this.titleField=this.editZone.append("span").classed("sprigTitleField",!0),this.textcontent=this.editZone.append("div").classed("textcontent",!0).attr("tabindex",0),this.editAvailable&&(this.addButton=this.textpane.append("button").text("+").classed("newsprigbutton",!0).classed("editcontrol",!0),this.deleteButton=this.textpane.append("button").text("-").classed("deletesprigbutton",!0).classed("editcontrol",!0),this.emphasizeCheckbox=this.textpane.append("label").text("Emphasize").classed("editcontrol",!0),this.textpane.append("input").attr({type:"checkbox",id:"emphasize"}).classed("editcontrol",!0)),this.editZone.style("display","none"),this.titleField.style("display","none"),d3.selectAll("#textpane *").style("display","none"),this.editAvailable&&(this.textcontent.on("click",this.startEditing.bind(this)),this.titleField.on("click",this.startEditing.bind(this)),this.addButton.on("click",this.sprigot.respondToAddChildSprigCmd),this.deleteButton.on("click",this.showDeleteSprigDialog),this.emphasizeCheckbox.on("click",this.respondToEmphasisCheckClick.bind(this)),this.editZone.on("keydown",this.respondToEditZoneKeyDown.bind(this)))},TextStuff.syncTextpaneWithTreeNode=function(e){this.textcontent.datum(e),this.titleField.datum(e),this.textcontent.html(e.body),this.titleField.html(e.title),this.emphasizeCheckbox.attr("value",this.graph.focusNode.emphasize?"on":null)},TextStuff.showTextpaneForTreeNode=function(e){this.syncTextpaneWithTreeNode(e),d3.selectAll("#textpane :not(.sprigTitleField)").style("display","block"),this.editZone.style("display","block"),this.uncollapseTextpane()},TextStuff.fadeInTextPane=function(e){if("none"===this.editZone.style("display")){var t=d3.selectAll("#textpane :not(.sprigTitleField)");this.textpane.style("opacity",0),t.style("opacity",0),this.editZone.style("opacity",0),t.style("display","block").transition().duration(e).style("opacity",1),this.editZone.style("display","block").transition().duration(e).style("opacity",1),this.textpane.transition().duration(e).style("opacity",1)}},TextStuff.initialTextPaneShow=function(e){setTimeout(function(){this.syncTextpaneWithTreeNode(e.datum(),this.graph.focusEl),this.fadeInTextPane(750)}.bind(this),725)},TextStuff.uncollapseTextpane=function(){var e=this.pane.classed("collapsedPane");e&&this.divider.toggleGraphExpansion()},TextStuff.showTitle=function(){this.titleField.text(this.titleField.datum().title),this.titleField.style("display","block")},TextStuff.makeId=function(e){return"s"+uid(e)},TextStuff.changeEditMode=function(e,t){if(this.editAvailable)if(this.textcontent.attr("contenteditable",e),this.titleField.attr("contenteditable",e),this.editZone.classed("editing",e),e)this.showTitle(),this.textcontent.node().focus();else{this.titleField.style("display","none");var i=this.textcontent.datum();i.body=this.textcontent.html();var n=this.titleField.text(),o=n!==i.title;i.title=n,o&&d3.select("#"+i.id+" text").text(i.title),this.textcontent.datum(i),this.titleField.datum(i),t||this.store.saveSprigFromTreeNode(this.textcontent.datum(),this.sprigot.docId)}},TextStuff.endEditing=function(){this.editZone.classed("editing")&&this.changeEditMode(!1)},TextStuff.showDeleteSprigDialog=function(){this.OKCancelDialog=new OKCancelDialog("#questionDialog","Do you want to delete this?","Delete",this.sprigot.respondToDeleteSprigCmd,function(){delete this.OKCancelDialog}.bind(this)),this.OKCancelDialog.show()},TextStuff.respondToEmphasisCheckClick=function(){this.graph.focusNode&&(this.graph.focusNode.emphasize="on"===this.value,this.treeRenderer.update(this.graph.nodeRoot))},TextStuff.respondToEditZoneKeyDown=function(){(d3.event.metaKey||d3.event.ctrlKey)&&13===d3.event.which&&(d3.event.stopPropagation(),this.editZone.classed("editing")&&this.changeEditMode(!1))},TextStuff.startEditing=function(){d3.event.stopPropagation(),this.editZone.classed("editing")||this.changeEditMode(!0)};var Divider={expanderArrow:null,graph:null,textStuff:null,camera:null};Divider.init=function(e,t,i,n){this.graph=t,this.textStuff=i,this.camera=n,this.expanderArrow=e.append("div").classed("divider",!0).append("svg").classed("arrowboard",!0).append("polygon").attr({id:"expanderArrow",fill:"rgba(0, 0, 64, 0.4)",stroke:"#E0EBFF","stroke-width":1,points:"0,0 32,24 0,48",transform:"translate(0, 0)"}),this.expanderArrow.on("click",this.toggleGraphExpansion.bind(this))},Divider.syncExpanderArrow=function(){var e=this.textStuff.pane.classed("collapsedPane"),t=e?36:6,i="translate("+t+", 0) ";i+="scale("+(e?"-1":"1")+", 1)",this.expanderArrow.transition().duration(500).ease("linear").attr("transform",i).attr("stroke-opacity",.5).attr("stroke-width",2).transition().delay(501).duration(500).attr("stroke-opacity",.15).attr("stroke-width",1)},Divider.toggleGraphExpansion=function(){var e=this.textStuff.pane.classed("collapsedPane"),t=!e;this.textStuff.pane.classed("collapsedPane",t).classed("pane",!t),this.graph.pane.classed("expandedPane",t).classed("pane",!t),this.syncExpanderArrow(),this.graph.focusEl&&this.camera.panToElement(d3.select(this.graph.focusEl))};var Historian={treeNav:null,docId:null};Historian.init=function(e,t){this.treeNav=e,this.docId=t,window.onpopstate=this.statePopped.bind(this)},Historian.statePopped=function(e){e.state&&(this.docId=e.state.docId,this.treeNav.goToSprig(e.state.sprigId,100))},Historian.syncURLToSprigId=function(e){if("object"!=typeof window.history.state||!window.history.state||"string"!=typeof window.history.state.docId||"string"!=typeof window.history.state.sprigId||window.history.state.docId!==this.docId||window.history.state.sprigId!==e){var t=location.protocol+"//"+location.host+"#/"+this.docId+"/"+e;window.history.pushState({docId:this.docId,sprigId:e},null,t)}};var margin={top:20,right:10,bottom:20,left:10},settings={serverURL:"http://sprigot-8939.onmodulus.net",treeNodeAnimationDuration:750},Sprigot={docId:null,graph:null};Sprigot.init=function(e,t){this.docId=e;var i=d3.select("body").append("section").attr("id","sprigot");this.graph=createGraph(),this.graph.init(i,Camera,TreeRenderer,TextStuff,Historian),Divider.init(i,this.graph,TextStuff,Camera),TextStuff.init(i,this.graph,TreeRenderer,Store,this,Divider),Historian.init(this.graph.treeNav,this.docId),Divider.syncExpanderArrow(),this.initDocEventResponders(),Store.getSprigTree(e,function(e,i){if(e)return console.log("Error while getting sprig:",e),void 0;if(i){var n=sanitizeTreeForD3(i);this.graph.loadNodeTreeToGraph(n,t),console.log("Loaded tree:",i)}else console.log("Sprig tree not found.")}.bind(this))},Sprigot.initDocEventResponders=function(){var e=d3.select(document);TextStuff.editAvailable&&e.on("click",TextStuff.endEditing.bind(TextStuff)),e.on("keyup",this.respondToDocKeyUp.bind(this)),e.on("keydown",this.respondToDocKeyDown.bind(this))},Sprigot.respondToDocKeyUp=function(){if(27===d3.event.keyCode)d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1);else if(!TextStuff.editZone.classed("editing"))switch(d3.event.which){case 69:d3.event.stopPropagation(),"block"===TextStuff.editZone.style("display")&&TextStuff.changeEditMode(!0);break;case 40:this.graph.treeNav.respondToDownArrow();break;case 38:this.graph.treeNav.respondToUpArrow();break;case 37:this.graph.treeNav.respondToLeftArrow();break;case 39:this.graph.treeNav.respondToRightArrow();break;case 187:d3.event.shiftKey&&respondToAddChildSprigCmd()}},Sprigot.respondToDocKeyDown=function(){(d3.event.metaKey||d3.event.ctrlKey)&&8===d3.event.which&&TextStuff.showDeleteSprigDialog()},Sprigot.respondToAddChildSprigCmd=function(){d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1);var e={id:TextStuff.makeId(8),doc:this.docId,title:"New Sprig",body:""},t=this.graph.focusNode.children;t||(t=this.graph.focusNode._children),t||(t=[]),t.push(e),this.graph.focusNode.children=t,TextStuff.changeEditMode(!0),Store.saveChildAndParentSprig(e,serializeTreedNode(this.graph.focusNode)),TreeRenderer.update(this.graph.nodeRoot,settings.treeNodeAnimationDuration,function(){this.graph.focusOnSprig(e.id),TextStuff.showTextpaneForTreeNode(e)})},Sprigot.respondToDeleteSprigCmd=function(){d3.event.stopPropagation(),TextStuff.editZone.classed("editing")&&TextStuff.changeEditMode(!1,!0);var e=this.graph.focusNode.parent,t=e.children.indexOf(this.graph.focusNode);e.children.splice(t,1);var i={id:this.graph.focusNode.id,doc:this.docId};Store.deleteChildAndSaveParentSprig(i,serializeTreedNode(e)),TreeRenderer.update(this.graph.nodeRoot,settings.treeNodeAnimationDuration,function(){setTimeout(function(){this.graph.treeNav.chooseTreeNode(e,d3.select("#"+e.id).node())},500)})},direct(location.hash);